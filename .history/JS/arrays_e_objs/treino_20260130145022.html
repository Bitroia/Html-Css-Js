<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <title>Treino App Template</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- RESET & VARS --- */
        :root { --gold: #FFD700; --bg: #000000; --card-bg: #151515; --text-muted: #666; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body {
            background-color: var(--bg); color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 15px; padding-bottom: 120px;
        }

        /* --- PROGRESSO --- */
        .progress-container { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: #111; z-index: 1001; }
        .progress-bar { height: 100%; background: var(--gold); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 8px var(--gold); }

        /* --- HEADER --- */
        .app-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #222; margin-top: 5px; }
        .logo-container { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .app-logo { width: 35px; height: 35px; object-fit: contain; border-radius: 6px; }
        .placeholder-logo { font-size: 22px; color: var(--gold); }
        .app-title { font-size: 16px; font-weight: 800; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }

        .header-icons { display: flex; gap: 10px; }
        .icon-btn { background: none; border: none; color: #555; font-size: 20px; cursor: pointer; padding: 8px; transition: color 0.3s; }
        .icon-btn.active { color: var(--gold); }
        .spin-anim { animation: spin 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(180deg); } }

        /* --- ABAS --- */
        .tabs-container { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; margin-bottom: 15px; scrollbar-width: none; }
        .tabs-container::-webkit-scrollbar { display: none; }
        .tab-wrapper { display: flex; flex-direction: column; align-items: center; gap: 5px; flex-shrink: 0; }
        
        .tab-btn {
            background: #111; color: #777; border: 1px solid #222; padding: 10px 18px;
            border-radius: 20px; font-weight: 700; font-size: 13px; white-space: nowrap; transition: all 0.2s;
        }
        .tab-btn.active { background: var(--gold); color: #000; border-color: var(--gold); transform: scale(1.05); }

        .tab-controls { display: flex; gap: 8px; margin-top: 2px; }
        .btn-tab-ctrl { width: 24px; height: 24px; border-radius: 50%; border: none; color: #fff; font-size: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-move { background: #333; } .btn-del { background: #d00; }

        /* --- CARDS --- */
        .card { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 12px; border: 1px solid #222; overflow: hidden; position: relative; transition: all 0.3s ease; }
        .card.calistenia { border-left: 3px solid var(--gold); }
        .card.musculacao { border-left: 3px solid #444; }
        .card.completed { border-color: #444; opacity: 0.8; }
        .card.completed .ex-name { color: var(--gold); }

        .card-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; min-height: 65px; cursor: pointer; }
        .info { flex-grow: 1; pointer-events: none; padding-right: 10px; }
        .ex-name { font-weight: 700; font-size: 15px; color: #eee; display: block; margin-bottom: 3px; }
        .ex-detail { color: #666; font-size: 12px; font-weight: 500; }
        
        .card-body { display: none; background-color: #0e0e0e; border-top: 1px solid #222; padding: 15px; }
        .card.open .card-body { display: block; }
        
        .expand-icon { color: #444; font-size: 12px; transition: transform 0.3s; margin-left: 10px; }
        .card.open .expand-icon { transform: rotate(180deg); color: var(--gold); }

        /* --- NOTE ICON --- */
        .note-toggle { font-size: 14px; margin-right: 5px; color: #444; transition: color 0.3s; }
        .note-toggle.has-note { color: var(--gold) !important; }

        /* --- EDIT CONTROLS --- */
        .edit-controls { display: none; align-items: center; gap: 12px; margin-right: 5px; }
        .editing .edit-controls { display: flex; }
        .editing .expand-icon, .editing .action-icons { display: none; }

        .btn-clean { background: none; border: none; font-size: 16px; cursor: pointer; padding: 5px; display: flex; align-items: center; }
        .btn-clean.move { color: #555; } .btn-clean.edit { color: #48f; } .btn-clean.del { color: #d33; } .btn-clean.dup { color: #aaa; }

        .action-icons { display: flex; align-items: center; gap: 10px; }

        /* --- CONTROLES INTERNOS --- */
        .controls-row { display: flex; flex-direction: column; gap: 12px; }
        .series-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        
        .circle {
            width: 38px; height: 38px; border-radius: 50%; border: 1px solid #333; background: #111; color: #555;
            display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px;
            transition: all 0.2s; cursor: pointer;
        }
        .circle.done { background: var(--gold); border-color: var(--gold); color: #000; transform: scale(1.1); box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }

        .inputs-row { display: flex; gap: 10px; justify-content: flex-end; width: 100%; margin-top: 5px; }
        .input-group { display: flex; align-items: center; gap: 6px; background: #1a1a1a; padding: 5px 10px; border-radius: 6px; border: 1px solid #2a2a2a; }
        .mini-label { font-size: 9px; color: #555; text-transform: uppercase; font-weight: 800; }
        
        .data-input { 
            background: transparent; border: none; border-bottom: 1px solid #333; color: #ddd; 
            width: 55px; height: 30px; text-align: center; font-weight: bold; font-size: 16px; transition: all 0.2s; border-radius: 0;
        }
        .data-input:focus { border-bottom-color: var(--gold); background: #111; outline: none; }

        .note-area { 
            width: 100%; background: #181818; border: 1px solid #333; color: #ccc; padding: 10px; 
            border-radius: 6px; font-size: 13px; margin-top: 10px; resize: none; min-height: 60px; display: none; 
        }
        .note-area.visible { display: block; animation: fadeIn 0.3s; }

        .btn-add { background: transparent; border: 1px dashed #444; color: #666; width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; font-size: 12px; font-weight: bold; text-transform: uppercase; cursor: pointer; }
        
        .finish-btn { 
            display: block; width: fit-content; margin: 30px auto; padding: 10px 30px; 
            background: var(--gold); color: #000; border: none; border-radius: 50px; 
            font-weight: 800; font-size: 13px; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2); cursor: pointer; transition: transform 0.2s;
        }
        .finish-btn:active { transform: scale(0.95); opacity: 0.8; }

        /* --- FAB TIMER --- */
        .fab-timer {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 1000; cursor: pointer; color: #000; 
            font-weight: 900; font-size: 16px; font-variant-numeric: tabular-nums;
        }

        /* --- MODAIS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(3px); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal { background: #1a1a1a; padding: 25px; border-radius: 16px; width: 90%; max-width: 350px; border: 1px solid #333; }
        .modal h3 { color: var(--gold); margin: 0 0 20px 0; text-align: center; text-transform: uppercase; font-size: 16px; letter-spacing: 1px; }
        .modal label { display: block; margin-top: 15px; color: #666; font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .modal input, .modal select, .modal textarea { width: 100%; padding: 12px; margin-top: 5px; background: #000; border: 1px solid #333; color: #fff; border-radius: 8px; font-size: 15px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 25px; }
        .btn-modal { padding: 12px; border-radius: 8px; border: none; font-weight: bold; flex: 1; font-size: 13px; cursor: pointer; }
        .btn-cancel { background: #333; color: #fff; } .btn-confirm { background: var(--gold); color: #000; }

        /* Timer Modal */
        .timer-display { font-size: 60px; text-align: center; font-weight: 800; margin: 10px 0 20px 0; color: #fff; font-variant-numeric: tabular-nums; }
        .timer-controls { display: flex; justify-content: center; gap: 20px; margin-bottom: 25px; }
        .btn-timer { width: 55px; height: 55px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; color: #fff; display: flex; align-items: center; justify-content: center; }
        .btn-start { background: #28a745; } .btn-stop { background: #d00; } .btn-reset { background: #444; }
        .timer-presets { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-top: 10px; }
        .chip { background: #222; color: #888; padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; border: 1px solid #333; font-weight: 600; }
        .chip.active { border-color: var(--gold); color: #fff; }

        /* Calculator Modal */
        .calc-result { text-align: center; margin-top: 20px; font-size: 32px; font-weight: 900; color: var(--gold); }
        .calc-sub { text-align: center; font-size: 12px; color: #666; margin-bottom: 20px; }

        /* History */
        .history-item { background: #111; border-left: 2px solid var(--gold); padding: 15px; margin-bottom: 10px; border-radius: 6px; }
        .history-date { font-size: 11px; color: var(--gold); margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        .history-name { font-weight: bold; font-size: 14px; color: #fff; }
        .history-summary { font-size: 12px; color: #888; margin-top: 8px; line-height: 1.4; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="progress-container"><div class="progress-bar" id="progress-bar"></div></div>

    <header class="app-header">
        <div class="logo-container">
            <div id="logo-render"></div>
            <span class="app-title" id="app-title-display">Treino Híbrido</span>
        </div>
        <div class="header-icons">
            <button class="icon-btn" onclick="openCalculator()" title="1RM"><i class="fas fa-calculator"></i></button>
            <button class="icon-btn" onclick="openHistory()" title="Histórico"><i class="fas fa-history"></i></button>
            <button class="icon-btn" onclick="openSettings()" title="Configurações & Backup"><i class="fas fa-sliders-h"></i></button>
            <button class="icon-btn edit-toggle" onclick="toggleEditMode()" title="Editar Treinos"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div class="tabs-container" id="tabs-list"></div>
    <div id="add-tab-btn" class="hidden" style="margin-bottom: 15px;"><button class="btn-add" onclick="showModal('tab')">+ Novo Dia</button></div>
    
    <div id="workout-container"></div>
    <button id="add-exercise-btn" class="btn-add hidden" onclick="showModal('exercise')"><i class="fas fa-plus"></i> Adicionar Exercício</button>

    <button class="finish-btn" onclick="finishWorkout()">Finalizar Treino</button>

    <div class="fab-timer" id="fab-timer" onclick="handleFabClick()">
        <i class="fas fa-stopwatch fab-icon"></i>
    </div>

    <div class="modal-overlay" id="modal-edit">
        <div class="modal">
            <h3 id="modal-title">Editar</h3>
            
            <div id="form-exercise" class="hidden">
                <label>Nome</label><input type="text" id="inp-ex-name">
                <label>Detalhes</label><input type="text" id="inp-ex-detail">
                <label>Séries</label><input type="number" id="inp-ex-series" value="4">
                <label>Descanso (seg)</label><input type="number" id="inp-ex-rest" placeholder="Padrão (Vazio)">
                <label>Tipo</label>
                <select id="inp-ex-type"><option value="calistenia">Calistenia (Ouro)</option><option value="musculacao">Musculação (Cinza)</option></select>
            </div>

            <div id="form-tab" class="hidden"><label>Nome do Dia</label><input type="text" id="inp-tab-name"></div>

            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-edit')">Cancelar</button>
                <button class="btn-modal btn-confirm" onclick="saveModal()">Salvar</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-config">
        <div class="modal">
            <h3>Configurações</h3>
            <label>Nome App</label><input type="text" id="inp-app-title">
            <label>Link Logo</label><input type="text" id="inp-logo-url">
            
            <hr style="border-color:#333; margin: 25px 0;">
            <h4 style="color:#888; margin:0 0 10px 0; font-size:11px; text-transform:uppercase;">Backup & Dados</h4>
            
            <button class="btn-add" onclick="downloadBackup()" style="margin-top:0; border-color:#48f; color:#48f;">
                <i class="fas fa-download"></i> Baixar Backup (.json)
            </button>
            
            <button class="btn-add" onclick="triggerUpload()" style="border-color:#28a745; color:#28a745;">
                <i class="fas fa-upload"></i> Restaurar Arquivo
            </button>
            <input type="file" id="backup-file" accept=".json" style="display:none" onchange="handleFileRestore(this)">

            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-config')">Fechar</button>
                <button class="btn-modal btn-confirm" onclick="saveConfig()">Salvar Info</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-calc">
        <div class="modal">
            <h3>Calculadora 1RM</h3>
            <label>Carga Levantada (kg)</label><input type="number" id="calc-weight" placeholder="Ex: 80" oninput="calculate1RM()">
            <label>Repetições Feitas</label><input type="number" id="calc-reps" placeholder="Ex: 8" oninput="calculate1RM()">
            <div class="calc-result" id="calc-result">0 kg</div>
            <div class="calc-sub">Sua Força Máxima Teórica</div>
            <div class="modal-btns"><button class="btn-modal btn-cancel" onclick="closeModal('modal-calc')">Fechar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-timer">
        <div class="modal">
            <h3 id="timer-title-modal">Descanso</h3>
            <div class="timer-display" id="timer-val">00:00</div>
            <div class="timer-controls">
                <button class="btn-timer btn-start" onclick="startTimer()"><i class="fas fa-play"></i></button>
                <button class="btn-timer btn-stop" onclick="pauseTimer()"><i class="fas fa-pause"></i></button>
                <button class="btn-timer btn-reset" onclick="resetTimer()"><i class="fas fa-redo"></i></button>
            </div>
            <label style="text-align:center">Predefinições:</label>
            <div class="timer-presets">
                <div class="chip" onclick="setDefaultRest(30)">30s</div>
                <div class="chip" onclick="setDefaultRest(60)">60s</div>
                <div class="chip" onclick="setDefaultRest(90)">90s</div>
                <div class="chip" onclick="setDefaultRest(120)">2m</div>
                <div class="chip" onclick="setStopwatchMode()">⏱️ Livre</div>
            </div>
            <div class="modal-btns" style="margin-top:20px"><button class="btn-modal btn-cancel" onclick="closeModal('modal-timer')">Fechar</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-history">
        <div class="modal" style="max-height:80vh;">
            <h3>Histórico</h3>
            <div id="history-list" style="max-height:300px; overflow-y:auto;"></div>
            <div class="modal-btns">
                <button class="btn-modal btn-cancel" onclick="closeModal('modal-history')">Fechar</button>
                <button class="btn-modal" style="background:#d00; color:#fff" onclick="clearHistory()">Limpar</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DADOS ATUALIZADOS: 5 DIAS COMPLETOS ---
        const defaultData = {
            title: "Treino Híbrido",
            logoUrl: "",
            defaultRest: 60,
            workouts: [
                {
                    id: "w_push",
                    name: "Dia 1 - Push",
                    exercises: [
                        { id: "e1", name: "Supino inclinado c/ halteres", detail: "Mobilidade membros sup. | 1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work)", series: 4, restTime: 120, type: "musculacao" },
                        { id: "e2", name: "Crucifixo polia alta", detail: "1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work) | Cadência 2/0/1/0", series: 4, restTime: 120, type: "musculacao" },
                        { id: "e3", name: "Pike push up", detail: "12 a 15 reps | Cadência 2/0/1/0", series: 4, restTime: 120, type: "calistenia" },
                        { id: "e4", name: "Dips (Paralelas)", detail: "10 a 15 reps | Peso opcional", series: 3, restTime: 180, type: "calistenia" },
                        { id: "e5", name: "Elevação lateral", detail: "4 séries (Warm/Feed/Work) | Realizar STRIP SET ao final", series: 4, restTime: 120, type: "musculacao" },
                        { id: "e6", name: "Tríceps corda", detail: "1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work)", series: 4, restTime: 120, type: "musculacao" },
                        { id: "e7", name: "Abdominal paralela", detail: "12 a 15 repetições", series: 3, restTime: 120, type: "calistenia" },
                        { id: "e8", name: "Prancha reta", detail: "1 a 2 min na posição", series: 3, restTime: 60, type: "calistenia" }
                    ]
                },
                {
                    id: "w_pull",
                    name: "Dia 2 - Pull",
                    exercises: [
                        { id: "p1", name: "Barra fixa", detail: "Mobilidade membros sup. | 10 a 15 reps", series: 4, restTime: 120, type: "calistenia" },
                        { id: "p2", name: "Remada baixa pronada", detail: "1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work) | Cadência 2/0/1/0", series: 4, restTime: 120, type: "musculacao" },
                        { id: "p3", name: "Tuck front lever", detail: "5 à 10 segundos | Cadência 2/0/1/0", series: 3, restTime: 120, type: "calistenia" },
                        { id: "p4", name: "Remada máquina unilateral", detail: "Pegada neutra | 1x15 (Warm), 1x10-12 (Feed), 1x8-10 (Work)", series: 3, restTime: 120, type: "musculacao" },
                        { id: "p5", name: "Bíceps barra reta", detail: "1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work) | Pico 2s", series: 4, restTime: 120, type: "musculacao" },
                        { id: "p6", name: "Rosca Martelo c/ halteres", detail: "1x15 (Warm), 1x10-12 (Feed), 1x8-10 (Work)", series: 3, restTime: 120, type: "musculacao" },
                        { id: "p7", name: "Panturrilha leg press", detail: "12 a 15 repetições", series: 4, restTime: 120, type: "musculacao" }
                    ]
                },
                {
                    id: "w_legs",
                    name: "Dia 3 - Legs",
                    exercises: [
                        { id: "l1", name: "Agachamento barra guiada", detail: "Mobilidade articular + 2 séries extensora (20 reps) | 1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work)", series: 4, restTime: 120, type: "musculacao" },
                        { id: "l2", name: "Pistol Squat", detail: "Livre. Use apoio se necessário.", series: 3, restTime: 120, type: "calistenia" },
                        { id: "l3", name: "Extensora (Cluster Set)", detail: "3 reps, 10s descanso, repita + 2 vezes.", series: 4, restTime: 120, type: "musculacao" },
                        { id: "l4", name: "Cadeira flexora", detail: "1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work) | Drop Set de 20% ao final", series: 4, restTime: 120, type: "musculacao" },
                        { id: "l5", name: "Adutora", detail: "1x15 (Warm up), 1x10-12 (Feeder), 1x8-10 (Work)", series: 3, restTime: 120, type: "musculacao" },
                        { id: "l6", name: "Abd oblíquo", detail: "12 a 15 repetições", series: 3, restTime: 60, type: "calistenia" }
                    ]
                },
                {
                    id: "w_upper",
                    name: "Dia 4 - Upper",
                    exercises: [
                        { id: "u1", name: "Handstand Push-up", detail: "Mobilidade articular | Veja vídeo nas observações", series: 4, restTime: 120, type: "calistenia" },
                        { id: "u2", name: "Pulldown", detail: "1x15 (Warm), 1x10-12 (Feed), 1x8-10 (Work)", series: 3, restTime: 120, type: "musculacao" },
                        { id: "u3", name: "Crucifixo polia baixa", detail: "1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work)", series: 4, restTime: 120, type: "musculacao" },
                        { id: "u4", name: "Flexões Diamante/Arqueiro", detail: "12 a 15 reps | Cadência 2/0/1/0", series: 4, restTime: 120, type: "calistenia" },
                        { id: "u5", name: "Abdução + Flexão ombros", detail: "Bi-set sentado | 1x15 (Warm), 1x10-12 (Feed), 1x8-10 (Work)", series: 3, restTime: 120, type: "musculacao" },
                        { id: "u6", name: "Biceps scott unilateral", detail: "1x15 (Warm), 1x10-12 (Feed), 1x8-10 (Work)", series: 3, restTime: 120, type: "musculacao" },
                        { id: "u7", name: "L-sit", detail: "Isometria - tempo livre", series: 4, restTime: 120, type: "calistenia" },
                        { id: "u8", name: "Triceps testa", detail: "1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work) | Strip Set ao final", series: 4, restTime: 120, type: "musculacao" }
                    ]
                },
                {
                    id: "w_lower",
                    name: "Dia 5 - Lower",
                    exercises: [
                        { id: "lw1", name: "Leg press 45º ou horizontal", detail: "Mobilidade articular de tornozelos, joelhos e quadril | 1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work)", series: 4, restTime: 120, type: "musculacao" },
                        { id: "lw2", name: "LEVANTAMENTO TERRA", detail: "1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work) | Ver vídeo", series: 4, restTime: 120, type: "musculacao" },
                        { id: "lw3", name: "Mesa flexora bi-set com Stiff", detail: "1x15 (Warm), 1x10-12 (Feed), 2x8-10 (Work)", series: 4, restTime: 120, type: "musculacao" },
                        { id: "lw4", name: "Flexão nórdica", detail: "Verificar volume inicial | Ver vídeo", series: 3, restTime: 120, type: "calistenia" },
                        { id: "lw5", name: "Cadeira extensora unilateral", detail: "1x15 (Warm), 1x10-12 (Feed), 1x8-10 (Work) | Pico 2s", series: 3, restTime: 120, type: "musculacao" },
                        { id: "lw6", name: "Cadeira abdutora", detail: "1x15 (Warm), 1x10-12 (Feed), 1x8-10 (Work)", series: 3, restTime: 120, type: "musculacao" },
                        { id: "lw7", name: "Panturrilha leg press", detail: "1x15 (Warm), 1x10-12 (Feed), 1x8-10 (Work) | Reps extras sem peso ao final", series: 3, restTime: 120, type: "musculacao" }
                    ]
                }
            ]
        };

        const STORAGE_KEY = 'hybridWorkout_template_v2';
        const HISTORY_KEY = 'hybridWorkout_history_template';

        let appData = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (!appData || !appData.workouts || appData.workouts.length === 0) { 
            appData = defaultData; 
            saveData(); 
        }
        if(!appData.defaultRest) { appData.defaultRest = 60; saveData(); }

        let activeTabId = appData.workouts.length > 0 ? appData.workouts[0].id : null;
        let isEditMode = false;
        let currentModalMode = '';
        let editingItemId = null;
        let timerInterval = null, timerTargetTime = 0, timerRunning = false, wakeLock = null;
        let timerMode = 'countdown';
        let timerSecondsCount = 0;

        function init() { renderHeader(); renderTabs(); renderWorkouts(); updateProgress(); checkTimer(); }
        document.addEventListener('DOMContentLoaded', init);

        // --- AUDIO ENGINE ---
        function playBeep() {
            try {
                const Ctx = window.AudioContext || window.webkitAudioContext;
                if (!Ctx) return;
                const ctx = new Ctx();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = "sine"; osc.frequency.value = 880; 
                gain.gain.value = 0.1; osc.start();
                setTimeout(() => osc.stop(), 200);
            } catch(e) {}
        }

        // --- RENDER ---
        function renderHeader() {
            document.getElementById('app-title-display').innerText = appData.title;
            const logo = document.getElementById('logo-render');
            if (appData.logoUrl) logo.innerHTML = `<img src="${appData.logoUrl}" class="app-logo">`;
            else logo.innerHTML = `<i class="fas fa-dumbbell placeholder-logo"></i>`;
        }

        function renderTabs() {
            const list = document.getElementById('tabs-list'); list.innerHTML = '';
            appData.workouts.forEach((w, i) => {
                const wrap = document.createElement('div'); wrap.className = 'tab-wrapper';
                const btn = document.createElement('button');
                btn.className = `tab-btn ${w.id === activeTabId ? 'active' : ''}`;
                btn.innerText = w.name;
                btn.onclick = () => { if(isEditMode) openEditTab(w.id); else { activeTabId = w.id; renderTabs(); renderWorkouts(); updateProgress(); }};
                wrap.appendChild(btn);
                if(isEditMode) {
                    const ctrls = document.createElement('div'); ctrls.className = 'tab-controls';
                    ctrls.innerHTML = `<button class="btn-tab-ctrl btn-move" onclick="moveTab(${i},-1)">⬅️</button><button class="btn-tab-ctrl btn-del" onclick="delTab('${w.id}')"><i class="fas fa-trash"></i></button><button class="btn-tab-ctrl btn-move" onclick="moveTab(${i},1)">➡️</button>`;
                    wrap.appendChild(ctrls);
                }
                list.appendChild(wrap);
            });
        }

        function renderWorkouts() {
            const cont = document.getElementById('workout-container'); cont.innerHTML = '';
            const w = appData.workouts.find(x => x.id === activeTabId);
            
            if (!w || w.exercises.length === 0) {
                cont.innerHTML = '<p style="text-align:center; color:#666; margin-top:40px; padding:20px;">Toque na engrenagem <i class="fas fa-cog"></i> para começar a adicionar exercícios.</p>';
                return;
            }

            w.exercises.forEach(ex => {
                const card = document.createElement('div');
                card.className = `card ${ex.type} ${isEditMode ? 'editing' : ''}`;
                
                let circles = ''; let doneCount = 0;
                for(let i=1; i<=ex.series; i++) {
                    const k = `${activeTabId}_${ex.id}_s${i}`; const d = localStorage.getItem(k) === 'true';
                    if(d) doneCount++;
                    circles += `<div class="circle ${d?'done':''}" onclick="toggleSeries('${activeTabId}_${ex.id}_s${i}', '${ex.id}', this)">${i}</div>`;
                }
                if(doneCount === ex.series && ex.series > 0) card.classList.add('completed');

                const load = localStorage.getItem(`${activeTabId}_${ex.id}_load`) || '';
                const rep = localStorage.getItem(`${activeTabId}_${ex.id}_rep`) || '';
                const note = localStorage.getItem(`${activeTabId}_${ex.id}_note`) || '';
                const hasNote = note.trim().length > 0;

                card.innerHTML = `
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="info"><span class="ex-name">${ex.name}</span><span class="ex-detail">${ex.detail}</span></div>
                        <div class="expand-icon">▼</div>
                        <div class="edit-controls">
                            <button class="btn-clean dup" onclick="duplicateEx('${ex.id}',event)"><i class="fas fa-copy"></i></button>
                            <button class="btn-clean move" onclick="moveEx('${ex.id}',-1,event)"><i class="fas fa-arrow-up"></i></button>
                            <button class="btn-clean move" onclick="moveEx('${ex.id}',1,event)"><i class="fas fa-arrow-down"></i></button>
                            <button class="btn-clean edit" onclick="openEditEx('${ex.id}',event)"><i class="fas fa-pen"></i></button>
                            <button class="btn-clean del" onclick="delEx('${ex.id}',event)"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="action-icons">
                            <button class="icon-btn note-toggle ${hasNote ? 'has-note' : ''}" onclick="toggleNote(this, event)"><i class="fas fa-sticky-note"></i></button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="controls-row">
                            <div class="series-row">${circles}</div>
                            <div class="inputs-row">
                                <div class="input-group"><span class="mini-label">Carga</span><input class="data-input" placeholder="0" value="${load}" oninput="saveInput('${activeTabId}_${ex.id}_load',this)"></div>
                                <div class="input-group"><span class="mini-label">Reps</span><input class="data-input" placeholder="0" value="${rep}" oninput="saveInput('${activeTabId}_${ex.id}_rep',this)"></div>
                            </div>
                        </div>
                        <textarea class="note-area ${hasNote?'visible':''}" placeholder="Notas..." oninput="saveNote('${activeTabId}_${ex.id}_note',this)">${note}</textarea>
                    </div>
                `;
                cont.appendChild(card);
            });
        }

        // --- LOGIC ---
        function openCalculator(e) { if(e) e.stopPropagation(); document.getElementById('modal-calc').style.display = 'flex'; }
        function calculate1RM() {
            const w = parseFloat(document.getElementById('calc-weight').value)||0;
            const r = parseFloat(document.getElementById('calc-reps').value)||0;
            document.getElementById('calc-result').innerText = (w>0 && r>0) ? Math.round(w*(1+r/30))+" kg" : "0 kg";
        }

        function toggleSeries(k, exId, el) {
            if(isEditMode) return;
            const wasDone = el.classList.contains('done');
            el.classList.toggle('done'); localStorage.setItem(k, !wasDone);
            const card = el.closest('.card');
            const total = card.querySelectorAll('.circle').length;
            const done = card.querySelectorAll('.circle.done').length;
            if(total===done && total>0) card.classList.add('completed'); else card.classList.remove('completed');
            updateProgress();
            
            if(!wasDone) {
                const w = appData.workouts.find(x => x.id === activeTabId);
                const ex = w.exercises.find(e => e.id === exId);
                const time = (ex.restTime !== undefined && ex.restTime !== null) ? parseInt(ex.restTime) : appData.defaultRest;
                if(time > 0) startRestTimer(time);
            }
        }

        function updateProgress() {
            const w = appData.workouts.find(x => x.id === activeTabId);
            if(!w) return;
            let tot=0; let dn=0;
            w.exercises.forEach(ex => { tot += ex.series; for(let i=1;i<=ex.series;i++) if(localStorage.getItem(`${activeTabId}_${ex.id}_s${i}`)==='true') dn++; });
            document.getElementById('progress-bar').style.width = tot===0 ? '0%' : (dn/tot*100)+'%';
        }

        // --- TIMER ENGINE ---
        async function reqWakeLock() { try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){} }
        function checkTimer() { const t = localStorage.getItem('timer_target'); if(t && parseInt(t) > Date.now()) startRestTimer(null, parseInt(t)); }

        function setStopwatchMode() {
            timerMode = 'stopwatch';
            timerSecondsCount = 0;
            document.getElementById('timer-val').innerText = "00:00";
            document.getElementById('timer-title-modal').innerText = "Cronômetro Livre";
            startTimerLogic();
        }

        function startRestTimer(sec, target=null) {
            timerMode = 'countdown';
            document.getElementById('timer-title-modal').innerText = "Descanso";
            if(timerInterval) clearInterval(timerInterval);
            timerTargetTime = target ? target : Date.now() + (sec * 1000);
            if(!target) localStorage.setItem('timer_target', timerTargetTime);
            startTimerLogic();
        }

        function startTimerLogic() {
            if(timerInterval) clearInterval(timerInterval);
            timerRunning = true; document.getElementById('fab-timer').classList.add('active'); reqWakeLock();
            
            if(timerMode === 'countdown') {
                updateTimerDisplay();
                timerInterval = setInterval(() => {
                    const diff = Math.ceil((timerTargetTime - Date.now()) / 1000);
                    if(diff <= 0) stopTimer(true); else updateFab(diff);
                    if(document.getElementById('modal-timer').style.display === 'flex') document.getElementById('timer-val').innerText = fmtTime(Math.max(0, diff));
                }, 500);
            } else {
                const startTime = Date.now() - (timerSecondsCount * 1000);
                timerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    timerSecondsCount = elapsed;
                    updateFab(elapsed);
                    if(document.getElementById('modal-timer').style.display === 'flex') document.getElementById('timer-val').innerText = fmtTime(elapsed);
                }, 1000);
            }
        }
        
        function updateTimerDisplay() {
             if(timerMode === 'countdown') {
                 const diff = Math.ceil((timerTargetTime - Date.now()) / 1000);
                 document.getElementById('timer-val').innerText = fmtTime(Math.max(0, diff));
             }
        }

        function stopTimer(fin=false) {
            clearInterval(timerInterval); timerInterval = null; timerRunning = false;
            localStorage.removeItem('timer_target');
            document.getElementById('fab-timer').classList.remove('active');
            document.getElementById('fab-timer').innerHTML = '<i class="fas fa-stopwatch fab-icon"></i>';
            if(wakeLock) wakeLock.release();
            if(fin) {
                if(navigator.vibrate) navigator.vibrate([200,100,200]);
                playBeep();
            }
        }
        function updateFab(s) { document.getElementById('fab-timer').innerText = s; }

        function finishWorkout() {
            if(!confirm("Deseja finalizar e salvar o treino atual?")) return;
            const w = appData.workouts.find(x => x.id === activeTabId);
            const entry = { date: new Date().toLocaleString(), name: w.name, ex: [] };
            w.exercises.forEach(ex => {
                const l = localStorage.getItem(`${activeTabId}_${ex.id}_load`);
                for(let i=1; i<=ex.series; i++) localStorage.removeItem(`${activeTabId}_${ex.id}_s${i}`);
                if(l) entry.ex.push(`${ex.name}: ${l}kg`);
            });
            const h = JSON.parse(localStorage.getItem(HISTORY_KEY)) || []; h.unshift(entry);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(h));
            renderWorkouts(); updateProgress();
        }

        // --- UI HELPERS ---
        function toggleCard(el) { if(!isEditMode) el.parentElement.classList.toggle('open'); }
        function toggleNote(b, e) { e.stopPropagation(); b.closest('.card').querySelector('.note-area').classList.toggle('visible'); }
        function saveInput(k, el) { localStorage.setItem(k, el.value); }
        function saveNote(k, el) { localStorage.setItem(k, el.value); const icon = el.closest('.card').querySelector('.note-toggle'); if(el.value.trim().length > 0) icon.classList.add('has-note'); else icon.classList.remove('has-note'); }
        function fmtTime(s) { return `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }
        function handleFabClick() { if(timerRunning) { if(confirm("Parar timer?")) stopTimer(); } else document.getElementById('modal-timer').style.display = 'flex'; }
        
        function openSettings() { 
            document.getElementById('inp-app-title').value = appData.title;
            document.getElementById('inp-logo-url').value = appData.logoUrl;
            document.getElementById('modal-config').style.display = 'flex'; 
        }
        
        function toggleEditMode() { isEditMode = !isEditMode; document.querySelector('.edit-toggle').classList.toggle('active'); document.querySelector('.edit-toggle i').classList.toggle('spin-anim'); document.getElementById('add-exercise-btn').classList.toggle('hidden'); document.getElementById('add-tab-btn').classList.toggle('hidden'); renderTabs(); renderWorkouts(); }
        function openHistory() { const h = JSON.parse(localStorage.getItem(HISTORY_KEY))||[]; const l = document.getElementById('history-list'); l.innerHTML = h.length?h.map(x=>`<div class="history-item"><div class="history-date">${x.date}</div><div class="history-name">${x.name}</div><div class="history-summary">${x.ex.join(', ')}</div></div>`).join(''):'<p style="text-align:center;color:#666">Nenhum registro encontrado.</p>'; document.getElementById('modal-history').style.display='flex'; }
        
        // --- BACKUP FILE ---
        function downloadBackup() {
            const data = { app: appData, history: JSON.parse(localStorage.getItem(HISTORY_KEY)) };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `treino_backup_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
        function triggerUpload() { document.getElementById('backup-file').click(); }
        function handleFileRestore(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.app) localStorage.setItem(STORAGE_KEY, JSON.stringify(data.app));
                    if(data.history) localStorage.setItem(HISTORY_KEY, JSON.stringify(data.history));
                    alert("Dados restaurados com sucesso!"); location.reload();
                } catch(err) { alert("Erro ao ler arquivo."); }
            };
            reader.readAsText(file);
        }

        // --- CRUD ---
        function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(appData)); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showModal(m, id=null) { currentModalMode=m; editingItemId=id; document.getElementById('modal-edit').style.display='flex'; ['form-exercise','form-tab'].forEach(f=>document.getElementById(f).classList.add('hidden')); if(m==='exercise') document.getElementById('form-exercise').classList.remove('hidden'); if(m==='tab') document.getElementById('form-tab').classList.remove('hidden'); }
        
        function saveConfig() {
            appData.title=document.getElementById('inp-app-title').value; 
            appData.logoUrl=document.getElementById('inp-logo-url').value;
            saveData(); closeModal('modal-config'); renderHeader();
        }

        function saveModal() { 
            if(currentModalMode==='exercise') {
                const w = appData.workouts.find(x=>x.id===activeTabId);
                const obj = { 
                    id: editingItemId||'e'+Date.now(), 
                    name:document.getElementById('inp-ex-name').value, 
                    detail:document.getElementById('inp-ex-detail').value, 
                    series:parseInt(document.getElementById('inp-ex-series').value), 
                    restTime: parseInt(document.getElementById('inp-ex-rest').value) || 0,
                    type:document.getElementById('inp-ex-type').value 
                };
                if(editingItemId) { const i=w.exercises.findIndex(e=>e.id===editingItemId); w.exercises[i]=obj; } else w.exercises.push(obj);
            }
            if(currentModalMode==='tab') { const n=document.getElementById('inp-tab-name').value; if(editingItemId) appData.workouts.find(x=>x.id===editingItemId).name=n; else { const t={id:'w'+Date.now(),name:n,exercises:[]}; appData.workouts.push(t); activeTabId=t.id; } }
            saveData(); closeModal('modal-edit'); renderHeader(); renderTabs(); renderWorkouts();
        }
        function openEditTab(id) { document.getElementById('inp-tab-name').value = appData.workouts.find(w=>w.id===id).name; showModal('tab', id); }
        function openEditEx(id, e) { 
            e.stopPropagation(); 
            const ex = appData.workouts.find(w=>w.id===activeTabId).exercises.find(e=>e.id===id); 
            document.getElementById('inp-ex-name').value=ex.name; 
            document.getElementById('inp-ex-detail').value=ex.detail; 
            document.getElementById('inp-ex-series').value=ex.series; 
            document.getElementById('inp-ex-rest').value=ex.restTime || '';
            document.getElementById('inp-ex-type').value=ex.type;
            showModal('exercise', id); 
        }
        function duplicateEx(id, e) {
            e.stopPropagation();
            const w = appData.workouts.find(x => x.id === activeTabId);
            const original = w.exercises.find(ex => ex.id === id);
            const copy = JSON.parse(JSON.stringify(original));
            copy.id = 'e' + Date.now(); copy.name += " (Cópia)";
            w.exercises.push(copy); saveData(); renderWorkouts();
        }
        function delEx(id, e) { e.stopPropagation(); if(confirm("Excluir exercício?")) { const w=appData.workouts.find(x=>x.id===activeTabId); w.exercises=w.exercises.filter(x=>x.id!==id); saveData(); renderWorkouts(); } }
        function moveEx(id, d, e) { e.stopPropagation(); const w=appData.workouts.find(x=>x.id===activeTabId); const i=w.exercises.findIndex(x=>x.id===id); if((d===-1&&i>0)||(d===1&&i<w.exercises.length-1)) { [w.exercises[i],w.exercises[i+d]]=[w.exercises[i+d],w.exercises[i]]; saveData(); renderWorkouts(); } }
        function delTab(id) { if(confirm("Excluir dia de treino?")) { appData.workouts=appData.workouts.filter(x=>x.id!==id); activeTabId=appData.workouts[0]?.id; saveData(); renderTabs(); renderWorkouts(); } }
        function moveTab(i, d) { if((d===-1&&i>0)||(d===1&&i<appData.workouts.length-1)) { [appData.workouts[i],appData.workouts[i+d]]=[appData.workouts[i+d],appData.workouts[i]]; saveData(); renderTabs(); } }
        function clearHistory() { if(confirm("Limpar todo o histórico?")) { localStorage.removeItem(HISTORY_KEY); openHistory(); } }
        function setDefaultRest(s) { appData.defaultRest = s; saveData(); document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); event.target.classList.add('active'); startTimerLogic(); }
        
        function startTimer() { startRestTimer(appData.defaultRest); closeModal('modal-timer'); }
        function pauseTimer() { stopTimer(); }
        function resetTimer() { stopTimer(); document.getElementById('timer-val').innerText = "00:00"; timerSecondsCount = 0; }
    </script>
</body>
</html>